<!DOCTYPE html>
<html lang="bn">
  <head>
    <script>
      document.addEventListener("contextmenu", (event) =>
        event.preventDefault()
      );
      document.addEventListener("keydown", (event) => {
        if (
          (event.ctrlKey &&
            ["u", "s", "i", "j"].includes(event.key.toLowerCase())) ||
          event.key === "F12"
        ) {
          event.preventDefault();
        }
      });
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Online Exam</title>
    <!-- Chart.js CDN -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Hind Siliguri", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      .container {
        font-family: "Hind Siliguri", sans-serif;
        width: 100%;
        margin: auto;
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        min-height: 80vh;
      }

      .exam-content {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        color: #1b0b54;
        text-align: center;
        margin-bottom: 10px;
      }

      #timer {
        font-size: 20px;
        color: #1b0b54;
        margin-bottom: 5px;
        font-weight: normal;
        text-align: center;
      }

      #exam-info {
        font-size: 16px;
        color: black;
        margin-bottom: 20px;
        text-align: center;
      }

      #exam {
        width: 100%;
        min-height: 100px;
      }

      .chart-container {
        width: 200px;
        height: 200px;
        margin: 10px auto;
        background-color: #f9f9f9;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: none;
        padding: 10px;
      }

      .chart-container.visible {
        display: block;
      }

      .question-container {
        text-align: left;
        margin-bottom: 20px;
        display: block;
      }

      .question-label {
        font-weight: bold;
        color: #1b0b54;
        margin-bottom: 10px;
      }

      .options {
        margin-top: 10px;
      }

      .option {
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 5px;
        border-radius: 5px;
        text-transform: uppercase;
      }

      .circle {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #1b0b54;
        margin-right: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #1b0b54;
        font-weight: bold;
        font-size: 18px;
      }

      .selected .circle {
        background-color: #1b0b54;
        color: white;
      }

      .correct-text {
        color: green !important;
      }

      .incorrect-text {
        color: #ff0800 !important;
      }

      .unattempted-text {
        color: orange !important;
      }

      #submitBtn {
        font-family: hind siliguri;
        padding: 15px 30px;
        background-color: #1b0b54;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        border-radius: 10px;
        margin-top: 20px;
        width: 200px;
        transition: background-color 0.3s ease;
      }

      #submitBtn:hover {
        background-color: #1b0b54;
      }

      .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        width: 300px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        text-align: center;
        display: none;
        z-index: 1000;
        transition: transform 0.5s ease, opacity 0.5s ease;
      }

      .popup.slide-out {
        transform: translate(-50%, -100%);
        opacity: 0;
      }

      .popup-header {
        background-color: #1b0b54;
        color: white;
        padding: 10px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 10px 10px 0 0;
      }

      .popup-body {
        padding: 15px;
      }

      .popup-body p {
        margin: 10px 0;
      }

      .confirm-btn {
        font-family: hind siliguri;
        background-color: #34c759;
        color: white;
        padding: 8px 15px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        border-radius: 5px;
        margin: 5px;
      }

      .confirm-btn:hover {
        background-color: #34c759;
      }

      .cancel-btn {
        background-color: #ff3b30;
        color: white;
        padding: 8px 15px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        border-radius: 5px;
        margin: 5px;
      }

      .cancel-btn:hover {
        background-color: #e02b21;
      }

      .explanation-dropdown {
        display: none;
        margin-top: 10px;
      }

      .explanation-dropdown.visible {
        display: block;
      }

      .explanation-btn {
        background-color: #1b0b54;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-family: "Hind Siliguri", sans-serif;
        width: 40%;
        text-align: left;
        position: relative;
      }

      .explanation-btn:hover {
        background-color: #1b0b54;
      }

      .explanation-btn::after {
        content: "▼";
        position: absolute;
        right: 10px;
        font-size: 12px;
      }

      .explanation-btn.active::after {
        content: "▲";
      }

      .explanation-content {
        display: none;
        padding: 15px;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        color: #000000;
        text-align: left;
        max-height: 450px;
        overflow-y: auto;
        margin-top: 5px;
      }

      .explanation-content.visible {
        display: block;
      }

      .explanation-content p {
        margin: 0 0 10px 0;
      }

      .explanation-content ul {
        margin: 0;
        padding-left: 20px;
      }

      .explanation-content li {
        margin-bottom: 5px;
      }

      .explanation-content strong {
        color: #1b0b54;
      }

      .explanation-label {
        font-weight: bold;
        color: #1b0b54;
        margin-bottom: 10px;
        display: block;
      }

      .locked .option {
        pointer-events: none;
        cursor: default;
      }

      .locked .option.selected {
        pointer-events: none;
        cursor: default;
      }
    </style>
  </head>

  <body>
    <div class="container" id="examContainer">
      <div class="exam-content">
        <h1>ইংরেজী অনুশীলন</h1>
        <div id="timer"></div>
        <div id="exam-info"></div>
        <div class="chart-container">
          <canvas id="scoreChart"></canvas>
        </div>
        <div id="exam">
          <!-- Questions will be generated dynamically -->
        </div>
        <button id="submitBtn">সাবমিট</button>
      </div>
    </div>

    <div class="popup" id="scorePopup">
      <div class="popup-header">তোমার স্কোর</div>
      <div class="popup-body">
        <p><strong>মোট প্রশ্ন:</strong> <span id="totalQuestions"></span></p>
        <p>
          <strong>উত্তর দিয়েছো:</strong>
          <span style="color: #000000" id="answered"></span>
        </p>
        <p>
          <strong>সঠিক উত্তর:</strong>
          <span style="color: #0ab853" id="correctAnswers"></span>
        </p>
        <p>
          <strong>ভুল উত্তর:</strong>
          <span style="color: #f81010" id="wrongAnswers"></span>
        </p>
        <p>
          <strong>অনুত্তরিত:</strong>
          <span style="color: #ffc801" id="unanswered"></span>
        </p>
        <p><strong>তোমার চূড়ান্ত স্কোর:</strong></p>
        <h2 style="color: #1b0b54"><span id="finalScore"></span></h2>
        <form id="scoreForm" action="https://formspree.io/f/xpby" method="POST">
          <input type="hidden" name="userID" id="formUserID" />
          <input type="hidden" name="finalScore" id="formFinalScore" />
          <input type="hidden" name="correctAnswers" id="formCorrectAnswers" />
          <input type="hidden" name="wrongAnswers" id="formWrongAnswers" />
          <input type="hidden" name="unanswered" id="formUnanswered" />
          <button
            type="submit"
            class="confirm-btn"
            style="background-color: #1b0b54"
          >
            <b>ওকে</b>
          </button>
        </form>
      </div>
    </div>

    <div class="popup" id="confirmPopup">
      <div class="popup-header">কনফার্ম করো</div>
      <div class="popup-body">
        <p>
          ভালো করে দেখে নাও! <br />
          পরীক্ষা শেষ করতে চাও তো?
        </p>
        <button class="confirm-btn" onclick="confirmSubmit()">
          <b>হ্যাঁ</b>
        </button>
        <button class="cancel-btn" onclick="cancelSubmit()"><b>না</b></button>
      </div>
    </div>

    <script>
      let chartInstance = null;

      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM fully loaded and parsed");
        const examContainer = document.getElementById("examContainer");
        if (!examContainer) {
          console.error("Exam container not found!");
          return;
        }
        try {
          sessionStorage.setItem("isLoggedIn", "true");
          sessionStorage.setItem("userID", "anonymous");
          console.log(
            "Session storage set: isLoggedIn = true, userID = anonymous"
          );
        } catch (e) {
          console.error("Session storage error:", e);
        }
        examContainer.style.display = "block";
        console.log("Exam container displayed");
        startTimer();
        generateQuestions();

        window.addEventListener("beforeunload", function (event) {
          if (
            examContainer.style.display === "block" &&
            sessionStorage.getItem("isLoggedIn") === "true"
          ) {
            autoSubmitScore();
          }
        });
      });

      const questions = [
        {
          id: 1,
          question: "She has no zest ___ music.",
          options: {
            a: "to",
            b: "in",
            c: "on",
            d: "for",
          },
          correct: "d",
          explanation:
            "'Zest for' means great enthusiasm and energy. So, 'She has no zest for music' means she has no enthusiasm for music.",
        },
        {
          id: 2,
          question: "We all thirst ___ happiness.",
          options: {
            a: "about",
            b: "upon",
            c: "after",
            d: "to",
          },
          correct: "c",
          explanation:
            "'Thirst after' means to have a strong desire or craving for something, especially something abstract like happiness, knowledge, or righteousness. It's often used metaphorically.",
        },
        {
          id: 3,
          question: "The old sailor saw his companions fall ___ dead.",
          options: {
            a: "in",
            b: "to",
            c: "down",
            d: "into",
          },
          correct: "c",
          explanation:
            "'Fall down' is a common phrasal verb meaning to drop to the ground. In this context, it implies falling to the ground and dying. 'Fall to dead' or 'fall into dead' are not standard idioms. 'Fall in dead' would mean falling inward while dead, which doesn't fit the context of simply dropping dead.",
        },
        {
          id: 4,
          question: "I was called to see him.",
          options: {
            a: "at",
            b: "for",
            c: "upon",
            d: "in",
          },
          correct: "c",
          explanation:
            "The idiom 'to call upon someone' means to visit someone, often formally or for a specific purpose. It fits the context of being summoned to see someone.",
        },
        {
          id: 5,
          question: "The gift was wrapped ___ blue paper.",
          options: {
            a: "by",
            b: "on",
            c: "in",
            d: "around",
          },
          correct: "c",
          explanation:
            "When something is enclosed or covered by a material, the preposition 'in' is used. 'Wrapped in' is the correct and common phrase to describe something being covered by paper.",
        },
        {
          id: 6,
          question: "The solution of the problem dawned ___ me.",
          options: {
            a: "on",
            b: "in",
            c: "is",
            d: "are",
          },
          correct: "a",
          explanation:
            "'Dawn on someone' is an idiom meaning that someone suddenly understands or realizes something. It signifies a sudden realization or comprehension.",
        },
        {
          id: 7,
          question: "I could not figure ___ what the teacher was talking ___",
          options: {
            a: "into, on",
            b: "by, on",
            c: "out, about",
            d: "on, about",
          },
          correct: "c",
          explanation:
            "'Figure out' means to understand or solve something. 'Talking about' means discussing a particular subject. Both fit the context perfectly.",
        },
        {
          id: 8,
          question: "We will have to adapt ___ any situation that may arise.",
          options: {
            a: "for",
            b: "from",
            c: "with",
            d: "to",
          },
          correct: "d",
          explanation:
            "'Adapt to' means to adjust or become suited to a new condition or situation. It indicates a necessary change in behavior or mindset to fit circumstances.",
        },
        {
          id: 9,
          question: "She went ___ the big gate ___ the prison ___ the road.",
          options: {
            a: "though, of, onto",
            b: "into, by, to",
            c: "across, inside, over",
            d: "by, to, on",
          },
          correct: "a",
          explanation:
            "'Through' implies passing from one side or end to the other. 'Of' indicates possession or association (the gate of the prison). 'Onto' indicates movement to a surface. So, 'She went through the big gate of the prison onto the road' means she passed through the gate of the prison and arrived on the road.",
        },
        {
          id: 10,
          question: "She took me ___ the hand and led me ___ the dais.",
          options: {
            a: "at, over",
            b: "in, on",
            c: "by, to",
            d: "on, from",
          },
          correct: "c",
          explanation:
            "'Take by the hand' is a common idiom meaning to hold someone's hand, often to guide them. 'Lead to' means to guide or conduct someone to a particular place. Both fit the context of someone guiding another person to a specific location.",
        },
        {
          id: 11,
          question:
            "When they became rich, they started looking ___ their neighbours.",
          options: {
            a: "down",
            b: "down at",
            c: "down on",
            d: "out on",
          },
          correct: "c",
          explanation:
            "'Look down on' (or 'look down upon') means to consider someone or something as inferior or unworthy of respect. It implies a sense of disdain or superiority. While 'look down at' means to physically look downwards, 'look down on' carries the metaphorical meaning of disdain.",
        },
        {
          id: 12,
          question: "I have been wondering ___ visiting Japan.",
          options: {
            a: "to",
            b: "on",
            c: "about",
            d: "over",
          },
          correct: "c",
          explanation:
            "'Wondering about' means thinking or speculating about something. It's the correct preposition to use when expressing contemplation or curiosity regarding a topic or activity.",
        },
        {
          id: 13,
          question: "He was unsure ___ himself.",
          options: {
            a: "in",
            b: "for",
            c: "of",
            d: "to",
          },
          correct: "c",
          explanation:
            "'Unsure of' means lacking confidence or certainty about something or oneself. It's the correct preposition to express doubt regarding one's abilities or decisions.",
        },
        {
          id: 14,
          question: "The gift was wrapped ___ blue paper.",
          options: {
            a: "by",
            b: "on",
            c: "around",
            d: "in",
          },
          correct: "d",
          explanation:
            "When something is enclosed or covered by a material, the preposition 'in' is used. 'Wrapped in' is the correct and common phrase to describe something being covered by paper.",
        },
        {
          id: 15,
          question: "It is dangerous to walk ___ the highway.",
          options: {
            a: "beside",
            b: "by",
            c: "in",
            d: "across",
          },
          correct: "d",
          explanation:
            "'Across' means from one side to the other of something. Walking across a highway implies traversing its width, which is dangerous due to traffic. 'Beside' and 'by' mean next to, which could still be dangerous but less so than crossing. 'In' the highway implies being in the lanes, which is equally dangerous.",
        },
        {
          id: 16,
          question: "The smaller animals can easily leap ___ tree to tree.",
          options: {
            a: "from",
            b: "in",
            c: "on",
            d: "onto",
          },
          correct: "a",
          explanation:
            "'From...to...' is used to indicate movement between two points or origins and destinations. So, 'leap from tree to tree' accurately describes the movement of animals jumping from one tree to another.",
        },
        {
          id: 17,
          question: "The charge of murder was brought ___ him.",
          options: {
            a: "against",
            b: "for",
            c: "about",
            d: "with",
          },
          correct: "a",
          explanation:
            "'Brought against' is the correct idiom when a charge or accusation is made. It means that the charge was formally presented or filed in opposition to him.",
        },
        {
          id: 18,
          question: "Sincerity is the root ___ success ___ all.",
          options: {
            a: "in, to",
            b: "to, in",
            c: "of, for",
            d: "for, of",
          },
          correct: "a",
          explanation:
            "'Root in' implies that something is founded or based on something else (sincerity is the foundation of success). 'Success to all' can be understood as success being available or achievable for everyone.",
        },
        {
          id: 19,
          question: "Truth triumphs ___ falsehood.",
          options: {
            a: "upon",
            b: "on",
            c: "off",
            d: "over",
          },
          correct: "d",
          explanation:
            "'Triumph over' means to achieve a victory or success over an opponent or obstacle. It signifies overcoming something successfully.",
        },
        {
          id: 20,
          question:
            "Even though we were the ___ the elections we could not form a government.",
          options: {
            a: "victors of",
            b: "victors in",
            c: "victors on",
            d: "victors for",
          },
          correct: "a",
          explanation:
            "'Victors of' is used to refer to the winners of a competition, war, or, in this case, elections. It specifies what they were victorious in.",
        },
        {
          id: 21,
          question: "The candles have been blown ___ by the wind.",
          options: {
            a: "out",
            b: "away",
            c: "of",
            d: "up",
          },
          correct: "a",
          explanation:
            "'Blown out' means to extinguish a flame, typically by a current of air. This is a common phrasal verb used for candles, fires, etc.",
        },
        {
          id: 22,
          question:
            "It's the first turning ___ the left after the traffic lights.",
          options: {
            a: "on",
            b: "in",
            c: "by",
            d: "for",
          },
          correct: "a",
          explanation:
            "The phrase 'on the left' (or 'on the right') is used to indicate direction or position. It means to turn in that specific direction.",
        },
        {
          id: 23,
          question:
            "I just can't come out with you tonight as I've got so ___ with my work.",
          options: {
            a: "up",
            b: "over",
            c: "away",
            d: "behind",
          },
          correct: "d",
          explanation:
            "'Got behind with' means to fall behind schedule or to be unable to keep up with one's work or tasks. It correctly implies being overburdened with work.",
        },
        {
          id: 24,
          question: "She was charged ___ murdering her brother-in-law.",
          options: {
            a: "of",
            b: "for",
            c: "with",
            d: "about",
          },
          correct: "c",
          explanation:
            "'Charged with' is the correct legal term, meaning to be formally accused of a crime. It specifies the offense one is accused of committing.",
        },
        {
          id: 25,
          question: "His manners are a witness ___ his rudeness.",
          options: {
            a: "of",
            b: "for",
            c: "with",
            d: "to",
          },
          correct: "d",
          explanation:
            "'Witness to' means to provide evidence or proof of something. In this context, his manners serve as evidence of his rudeness.",
        },
        {
          id: 26,
          question: "A drowning person ___ a straw",
          options: {
            a: "catches",
            b: "catches after",
            c: "catches for",
            d: "catches at",
          },
          correct: "d",
          explanation:
            "'Catch at' means to try to grasp something, often desperately or frantically. The idiom 'a drowning man will clutch at a straw' means that someone in a desperate situation will try any solution, no matter how unlikely.",
        },
        {
          id: 27,
          question: "Javed was leaning ___ a lamp post.",
          options: {
            a: "against",
            b: "for",
            c: "before",
            d: "by",
          },
          correct: "a",
          explanation:
            "'Leaning against' means to rest one's body or an object on something for support. It indicates physical contact and support.",
        },
        {
          id: 28,
          question: "We rounded ___ the meal with sweets.",
          options: {
            a: "off",
            b: "out",
            c: "up",
            d: "down",
          },
          correct: "c",
          explanation:
            "'Round up' can mean to bring together or to conclude something. In the context of a meal, 'rounded up the meal with sweets' implies concluding the meal by serving sweets.",
        },
        {
          id: 29,
          question: "Fill in the blank: Don't run ___ money always.",
          options: {
            a: "in",
            b: "into",
            c: "out",
            d: "after",
          },
          correct: "d",
          explanation:
            "'Run after' means to pursue or chase something, often implying a strong desire or obsession. In this case, it means to constantly pursue money.",
        },
        {
          id: 30,
          question: "A lion jumped ___ the trees.",
          options: {
            a: "from behind",
            b: "out of",
            c: "outside of",
            d: "from among",
          },
          correct: "b",
          explanation:
            "'Jumped out of' indicates movement from an enclosed space or position. If the lion was among or behind the trees, jumping 'out of' them would imply emerging from their concealment.",
        },
        {
          id: 31,
          question: "I asked him to look ___ the matter.",
          options: {
            a: "for",
            b: "at",
            c: "into",
            d: "about",
          },
          correct: "c",
          explanation:
            "'Look into' means to investigate or examine something thoroughly. It is commonly used when asking someone to research or delve deeper into an issue.",
        },
        {
          id: 32,
          question: "The snow swirls ___ the valley.",
          options: {
            a: "up",
            b: "in",
            c: "down",
            d: "through",
          },
          correct: "c",
          explanation:
            "'Swirls down' describes the downward motion of snow, often in a circular or spiral pattern, into the valley. While 'in' or 'through' could describe presence, 'down' specifies the direction of movement into the lower area of the valley.",
        },
        {
          id: 33,
          question: "He parted ___ his friends in tears.",
          options: {
            a: "with",
            b: "from",
            c: "against",
            d: "beside",
          },
          correct: "b",
          explanation:
            "'Part from' means to separate from a person. 'Part with' is used for possessions or things. So, 'parted from his friends' is correct when referring to people.",
        },
        {
          id: 34,
          question: "Recourse ___ arms is not the best solution to",
          options: {
            a: "to",
            b: "for",
            c: "with",
            d: "of",
          },
          correct: "a",
          explanation:
            "'Recourse to' means resorting to or turning to something for help or protection, especially in a difficult situation. In this context, it implies turning to violence (arms) as a solution.",
        },
        {
          id: 35,
          question: "Many prefer donating money ___ distributing clothes.",
          options: {
            a: "than",
            b: "but",
            c: "to",
            d: "without",
          },
          correct: "c",
          explanation:
            "When expressing preference between two things, the construction 'prefer X to Y' is used. 'Prefer donating money to distributing clothes' means they favor donating money over distributing clothes.",
        },
      ];

      const totalQuestions = questions.length;
      let timeLeft = Math.floor(totalQuestions / 2) * 60;
      const timerElement = document.getElementById("timer");
      let timerInterval;

      function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.innerText = `${toBengaliNumber(
          minutes
        )} মিনিট ${toBengaliNumber(seconds)} সেকেন্ড`;

        if (timeLeft > 0) {
          timeLeft--;
        } else {
          stopTimer();
          confirmSubmit();
        }
      }

      function startTimer() {
        console.log("Starting timer");
        timerElement.innerText = `${toBengaliNumber(
          Math.floor(timeLeft / 60)
        )} মিনিট ${toBengaliNumber(timeLeft % 60)} সেকেন্ড`;
        timerInterval = setInterval(updateTimer, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        console.log("Timer stopped");
      }

      function toBengaliNumber(num) {
        const bengaliDigits = [
          "০",
          "১",
          "২",
          "৩",
          "৪",
          "৫",
          "৬",
          "৭",
          "৮",
          "৯",
        ];
        let numStr = num.toString();

        let isNegative = num < 0;
        if (isNegative) {
          numStr = numStr.substring(1);
        }

        if (numStr.includes(".")) {
          let [integerPart, decimalPart] = numStr.split(".");
          let integerBengali = integerPart
            .split("")
            .map((digit) => bengaliDigits[parseInt(digit)])
            .join("");
          let decimalBengali = decimalPart
            .split("")
            .map((digit) => bengaliDigits[parseInt(digit)])
            .join("");
          return (
            (isNegative ? "−" : "") + integerBengali + "." + decimalBengali
          );
        } else {
          let integerBengali = numStr
            .split("")
            .map((digit) => bengaliDigits[parseInt(digit)])
            .join("");
          return (isNegative ? "−" : "") + integerBengali;
        }
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function generateQuestions() {
        console.log("Generating questions");
        const examContainer = document.querySelector("#exam");
        if (!examContainer) {
          console.error("Exam container (#exam) not found!");
          return;
        }
        examContainer.innerHTML = "";
        console.log("Questions array:", questions);
        const shuffledQuestions = shuffleArray([...questions]);
        shuffledQuestions.forEach((question, index) => {
          console.log(`Generating question ${index + 1}:`, question);
          const questionDiv = document.createElement("div");
          questionDiv.classList.add("question-container");
          questionDiv.setAttribute("data-question", question.id);
          questionDiv.setAttribute("data-correct", question.correct);

          let optionsHTML = "";
          for (let option in question.options) {
            optionsHTML += `
                                                                          <label class="option" data-option="${option}">
                                                                            <div class="circle">${option}</div>
                                                                            <span class="option-text">${question.options[option]}</span>
                                                                          </label>
                                                                        `;
          }

          const explanationHTML = question.explanation
            ? `<div class="explanation-dropdown">
                                                                             <button class="explanation-btn">ব্যাখ্যা দেখো</button>
                                                                             <div class="explanation-content">
                                                                               <div class="explanation-label">ব্যাখ্যা:</div>
                                                                               ${question.explanation}
                                                                             </div>
                                                                           </div>`
            : "";

          questionDiv.innerHTML = `
                                                                        <p class="question-label">${
                                                                          index +
                                                                          1
                                                                        }. ${
            question.question
          }</p>
                                                                        <div class="options">
                                                                          ${optionsHTML}
                                                                        </div>
                                                                        ${explanationHTML}
                                                                      `;
          examContainer.appendChild(questionDiv);
          console.log(`Appended question ${index + 1} to exam container`);
        });

        const questionContainers = document.querySelectorAll(
          ".question-container"
        );
        console.log(`Found ${questionContainers.length} question containers`);
        questionContainers.forEach((container, idx) => {
          console.log(`Setting question ${idx + 1} to visible`);
          container.style.display = "block";
        });

        document.querySelectorAll(".option").forEach((option) => {
          option.addEventListener(
            "click",
            function (e) {
              e.preventDefault();
              const parent = this.closest(".question-container");
              if (parent.classList.contains("locked")) return;
              parent.classList.add("locked");
              parent.querySelectorAll(".option").forEach((el) => {
                if (el !== this) {
                  el.style.pointerEvents = "none";
                  el.style.cursor = "default";
                }
                el.classList.remove("selected");
              });
              this.classList.add("selected");
              console.log(
                `Option selected for question ${parent.getAttribute(
                  "data-question"
                )}: ${this.getAttribute("data-option")}`
              );
            },
            { once: true }
          );
        });

        document.querySelectorAll(".explanation-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const content = this.nextElementSibling;
            content.classList.toggle("visible");
            this.classList.toggle("active");
            console.log("Toggled explanation visibility");
          });
        });

        const examInfo = document.getElementById("exam-info");
        if (examInfo) {
          examInfo.innerText = `পূর্ণ নম্বরঃ ${toBengaliNumber(
            totalQuestions
          )}`;
          console.log("Exam info updated");
        } else {
          console.error("Exam info element not found!");
        }
      }

      function initializeChart() {
        console.log("Initializing chart");
        const ctx = document.getElementById("scoreChart").getContext("2d");
        chartInstance = new Chart(ctx, {
          type: "pie",
          data: {
            labels: ["ঠিক উত্তর", "ভুল উত্তর", "অনুত্তরিত"],
            datasets: [
              {
                data: [0, 0, 0],
                backgroundColor: ["#34c759", "#ff3b30", "#007aff"],
                borderColor: "#fff",
                borderWidth: 2,
                hoverOffset: 10,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "10%",
            layout: {
              padding: 10,
            },
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  font: {
                    family: '"Hind Siliguri", sans-serif',
                    size: 13,
                    weight: "bold",
                  },
                  color: "#333",
                  padding: 12,
                  boxWidth: 14,
                  generateLabels: (chart) => {
                    const data = chart.data;
                    return data.labels.map((label, i) => ({
                      text: label,
                      font: {
                        family: '"Hind Siliguri", sans-serif',
                      },
                      fillStyle: data.datasets[0].backgroundColor[i],
                      hidden: !chart.getDataVisibility(i),
                      index: i,
                    }));
                  },
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.9)",
                cornerRadius: 6,
                titleFont: {
                  family: '"Hind Siliguri", sans-serif',
                  size: 14,
                  weight: "bold",
                },
                bodyFont: {
                  family: '"Hind Siliguri", sans-serif',
                  size: 13,
                },
                padding: 10,
                boxPadding: 5,
              },
            },
            animation: {
              animateScale: true,
              animateRotate: true,
              duration: 1000,
              easing: "easeOutQuart",
            },
            elements: {
              arc: {
                borderRadius: 8,
              },
            },
            onClick: (e, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const filter = ["correct", "wrong", "unanswered"][index];
                filterQuestions(filter);
              } else {
                filterQuestions("all");
              }
            },
          },
        });
        console.log("Chart initialized");
      }

      function filterQuestions(type) {
        console.log(`Filtering questions by type: ${type}`);
        document.querySelectorAll(".question-container").forEach((question) => {
          const status = question.getAttribute("data-status");
          if (type === "all" || status === type) {
            question.style.display = "block";
          } else {
            question.style.display = "none";
          }
        });
      }

      function showConfirmPopup() {
        console.log("Showing confirm popup");
        document.getElementById("confirmPopup").style.display = "block";
      }

      function autoSubmitScore() {
        console.log("Auto-submitting score");
        stopTimer();
        let score = 0,
          total = questions.length,
          answered = 0,
          correct = 0,
          wrong = 0,
          unanswered = 0;

        document.querySelectorAll(".question-container").forEach((question) => {
          let correctAnswer = question.getAttribute("data-correct");
          let selectedOption = question.querySelector(".option.selected");

          if (selectedOption) {
            answered++;
            let chosenAnswer = selectedOption.getAttribute("data-option");
            if (chosenAnswer === correctAnswer) {
              score += 1;
              correct++;
              question.setAttribute("data-status", "correct");
            } else {
              score -= 0.25;
              wrong++;
              question.setAttribute("data-status", "wrong");
            }
          } else {
            unanswered++;
            question.setAttribute("data-status", "unanswered");
          }
        });

        const userID = sessionStorage.getItem("userID") || "anonymous";
        const formData = new FormData();
        formData.append("userID", userID);
        formData.append("finalScore", score.toFixed(2));
        formData.append("correctAnswers", correct);
        formData.append("wrongAnswers", wrong);
        formData.append("unanswered", unanswered);

        const url = "https://formspree.io/f/xpwy";
        navigator.sendBeacon(url, formData);
        console.log("Auto-submission sent via sendBeacon for userID:", userID);
      }

      function confirmSubmit() {
        console.log("Confirming submission");
        document.getElementById("confirmPopup").style.display = "none";
        stopTimer();
        let score = 0,
          total = questions.length,
          answered = 0,
          correct = 0,
          wrong = 0,
          unanswered = 0;

        document
          .querySelectorAll(".question-container")
          .forEach((question, index) => {
            let correctAnswer = question.getAttribute("data-correct");
            let selectedOption = question.querySelector(".option.selected");

            if (selectedOption) {
              answered++;
              let chosenAnswer = selectedOption.getAttribute("data-option");
              if (chosenAnswer === correctAnswer) {
                selectedOption
                  .querySelector(".option-text")
                  .classList.add("correct-text");
                score += 1;
                correct++;
                question.setAttribute("data-status", "correct");
              } else {
                selectedOption
                  .querySelector(".option-text")
                  .classList.add("incorrect-text");
                question
                  .querySelector(
                    `[data-option="${correctAnswer}"] .option-text`
                  )
                  .classList.add("correct-text");
                score -= 0.25;
                wrong++;
                question.setAttribute("data-status", "wrong");
              }
            } else {
              question
                .querySelector(`[data-option="${correctAnswer}"] .option-text`)
                .classList.add("unattempted-text");
              unanswered++;
              question.setAttribute("data-status", "unanswered");
            }
            question.style.display = "block";

            const explanationDropdown = question.querySelector(
              ".explanation-dropdown"
            );
            if (explanationDropdown) {
              explanationDropdown.classList.add("visible");
            }
          });

        const chartContainer = document.querySelector(".chart-container");
        chartContainer.classList.add("visible");
        if (!chartInstance) {
          initializeChart();
        }
        chartInstance.data.datasets[0].data = [correct, wrong, unanswered];
        chartInstance.update();
        console.log("Chart updated with data:", [correct, wrong, unanswered]);

        const userID = sessionStorage.getItem("userID") || "anonymous";
        document.getElementById("totalQuestions").innerText =
          toBengaliNumber(total);
        document.getElementById("answered").innerText =
          toBengaliNumber(answered);
        document.getElementById("correctAnswers").innerText =
          toBengaliNumber(correct);
        document.getElementById("wrongAnswers").innerText =
          toBengaliNumber(wrong);
        document.getElementById("unanswered").innerText =
          toBengaliNumber(unanswered);
        document.getElementById("finalScore").innerText = toBengaliNumber(
          score.toFixed(2)
        );

        document.getElementById("formUserID").value = userID;
        document.getElementById("formFinalScore").value = score.toFixed(2);
        document.getElementById("formCorrectAnswers").value = correct;
        document.getElementById("formWrongAnswers").value = wrong;
        document.getElementById("formUnanswered").value = unanswered;

        document.getElementById("submitBtn").style.display = "none";

        document.getElementById("scorePopup").style.display = "block";

        const form = document.getElementById("scoreForm");
        fetch(form.action, {
          method: "POST",
          body: new FormData(form),
          headers: {
            Accept: "application/json",
          },
        })
          .then((response) => {
            if (response.ok) {
              console.log("Form submitted successfully");
              form.reset();
            } else {
              console.error("Form submission failed:", response.statusText);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function cancelSubmit() {
        console.log("Canceling submission");
        document.getElementById("confirmPopup").style.display = "none";
      }

      document
        .getElementById("submitBtn")
        .addEventListener("click", function () {
          console.log("Submit button clicked");
          showConfirmPopup();
        });

      function closePopup() {
        console.log("Closing score popup");
        const scorePopup = document.getElementById("scorePopup");
        scorePopup.classList.add("slide-out");
        setTimeout(() => {
          scorePopup.style.display = "none";
          scorePopup.classList.remove("slide-out");
          window.scrollTo({ top: 0, behavior: "smooth" });
        }, 500);
      }

      document
        .getElementById("scoreForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          console.log("Score form submitted");
          closePopup();
        });
    </script>
  </body>
</html>
